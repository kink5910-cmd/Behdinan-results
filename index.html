<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kurdish Master Notebook</title>
    <!-- FontAwesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ------------------- 1. SYSTEM & VARIABLES ------------------- */
        :root {
            --gold: #d4af37;
            --gold-dark: #b8860b;
            --dark-overlay: rgba(0, 0, 0, 0.75);
            --glass-bg: rgba(20, 20, 20, 0.85);
            --text-color: #ffffff;
            --bg-lantern: url('https://i.pinimg.com/736x/87/07/f3/8707f30089209581729222c09192931d.jpg'); /* Blue Lantern */
            --bg-room: url('https://i.pinimg.com/originals/e8/34/07/e8340702de2922765870df73356e9275.jpg'); /* Sunlit Room */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: #000;
            color: var(--text-color);
            overflow: hidden; 
            height: 100vh;
        }

        /* ------------------- 2. BACKGROUND TRANSITION ------------------- */
        #dynamic-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            transition: background-image 2s ease-in-out, filter 2s ease;
            z-index: -2;
        }
        
        /* Phase 1: Lantern (Dark) */
        .bg-phase-1 {
            background-image: var(--bg-lantern);
            filter: brightness(0.6);
        }

        /* Phase 2: Room (Bright but dimmed for text) */
        .bg-phase-2 {
            background-image: var(--bg-room);
            filter: brightness(0.4) blur(3px);
        }

        /* ------------------- 3. INTRO SCREEN ------------------- */
        #intro-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .lantern-glow {
            width: 150px; height: 150px; border-radius: 50%;
            box-shadow: 0 0 50px rgba(0, 150, 255, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(0.9); } }
        
        .intro-text {
            margin-top: 20px; color: #aaddff; font-size: 1.2em; text-align: center;
            text-shadow: 0 0 10px #000; animation: fadeIn 3s;
        }

        /* ------------------- 4. MAIN APP LAYOUT ------------------- */
        #main-app {
            display: none;
            height: 100vh;
            overflow-y: auto;
            position: relative;
            padding-bottom: 70px;
            animation: appFadeIn 2s ease;
        }
        @keyframes appFadeIn { from { opacity: 0; } to { opacity: 1; } }

        .container { width: 90%; max-width: 480px; margin: 20px auto; }
        
        .card {
            background: var(--glass-bg);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 15px;
            padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        input, select, textarea {
            width: 100%; padding: 12px; margin: 8px 0;
            background: rgba(255,255,255,0.1); border: 1px solid #444;
            color: white; border-radius: 8px; outline: none; text-align: right;
        }
        input:focus { border-color: var(--gold); }
        
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; margin-top: 10px;
            transition: 0.3s;
        }
        .btn-gold { background: linear-gradient(45deg, var(--gold-dark), var(--gold)); color: #000; }
        .btn-gold:active { transform: scale(0.98); }
        .btn-red { background: #8b0000; color: white; }

        /* ------------------- 5. AUTH SCREEN ------------------- */
        #auth-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px;
        }
        .auth-switch { display: flex; border-bottom: 1px solid #444; margin-bottom: 20px; }
        .switch-btn { flex: 1; padding: 10px; text-align: center; color: #888; cursor: pointer; }
        .switch-btn.active { color: var(--gold); border-bottom: 2px solid var(--gold); }

        /* ------------------- 6. FOLDERS TAB ------------------- */
        .folder-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .folder-title { color: var(--gold); font-size: 1.2em; font-weight: bold; }
        .folder-score { background: rgba(212, 175, 55, 0.2); padding: 5px 10px; border-radius: 5px; color: var(--gold); }
        
        .grade-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .grade-actions i { margin-left: 10px; cursor: pointer; color: #aaa; }
        .grade-actions i:hover { color: var(--gold); }

        /* ------------------- 7. PROFILE (INSTA STYLE) ------------------- */
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .p-img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; }
        .p-stats { display: flex; gap: 15px; text-align: center; flex: 1; justify-content: space-around; }
        .stat-num { font-weight: bold; font-size: 1.2em; display: block; }
        .stat-label { font-size: 0.8em; color: #aaa; }
        
        .bio-section { margin-bottom: 15px; font-size: 0.9em; line-height: 1.5; }
        .social-links { display: flex; gap: 10px; margin-bottom: 20px; }
        .s-link { flex: 1; background: #333; padding: 8px; text-align: center; border-radius: 6px; text-decoration: none; color: white; font-size: 0.9em; }

        /* Ranking */
        .rank-card { background: linear-gradient(to right, rgba(20,20,20,0.9), rgba(50,50,50,0.5)); border-left: 3px solid var(--gold); padding: 10px; margin-bottom: 5px; display: flex; align-items: center; }
        .rank-num { font-size: 1.5em; font-weight: bold; color: var(--gold); margin-left: 15px; width: 30px; }
        .rank-user { font-weight: bold; }

        /* ------------------- 8. CHAT SYSTEM ------------------- */
        .chat-row { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .chat-row:hover { background: rgba(255,255,255,0.05); }
        .c-avatar { width: 50px; height: 50px; border-radius: 50%; margin-left: 15px; object-fit: cover; }
        
        /* Chat Interface */
        #chat-room {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: none; flex-direction: column;
        }
        .cr-header { padding: 10px 15px; background: #111; display: flex; align-items: center; border-bottom: 1px solid #333; }
        .cr-body { flex: 1; overflow-y: auto; padding: 15px; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }
        .cr-footer { padding: 10px; background: #111; display: flex; align-items: center; gap: 10px; }

        /* Messages */
        .msg { max-width: 80%; padding: 10px 15px; margin: 5px 0; border-radius: 15px; position: relative; word-wrap: break-word; font-size: 0.95em; }
        .msg-me { background: var(--gold); color: black; margin-right: auto; border-radius: 15px 15px 15px 0; }
        .msg-other { background: #333; color: white; margin-left: auto; border-radius: 15px 15px 0 15px; }

        /* Edu Widgets */
        .edu-widget { background: rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 8px; margin-top: 5px; }
        .poll-bar { height: 8px; background: #555; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .poll-fill { height: 100%; background: #000; width: 0%; transition: 0.5s; }
        .quiz-opt { display: block; background: rgba(255,255,255,0.2); margin: 4px 0; padding: 6px; border-radius: 4px; cursor: pointer; text-align: center; }
        .quiz-correct { background: #28a745 !important; color: white; }
        .quiz-wrong { background: #dc3545 !important; color: white; }

        /* Tools Menu */
        #tools-menu {
            position: absolute; bottom: 70px; right: 10px; width: 220px;
            background: #222; border: 1px solid var(--gold); border-radius: 10px;
            display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .tool-item { padding: 12px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .tool-item i { width: 25px; text-align: center; color: var(--gold); }

        /* ------------------- 9. NAVBAR ------------------- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: #0a0a0a; border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center; z-index: 500;
        }
        .nav-item { color: #666; font-size: 1.4em; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--gold); transform: translateY(-5px); }
        .nav-pic { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #666; object-fit: cover; }
        .nav-item.active .nav-pic { border-color: var(--gold); }

        /* ------------------- 10. MODALS ------------------- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid var(--gold); }
    </style>
</head>
<body>

    <!-- LAYERS -->
    <div id="dynamic-bg" class="bg-phase-1"></div>

    <!-- INTRO -->
    <div id="intro-screen" onclick="startApp()">
        <div class="lantern-glow"></div>
        <p class="intro-text">ŸÅÿßŸÜŸàÿ≥€é Ÿá€ïŸÑ⁄©€ï (Click)</p>
    </div>

    <!-- MAIN APP -->
    <div id="main-app">

        <!-- AUTH (Login/Signup) FIXED -->
        <div id="auth-view" class="container" style="display:none;">
            <div class="card" id="auth-container">
                <h2 style="text-align:center; color:var(--gold); margin-bottom:20px; font-family:'Times New Roman', serif; letter-spacing:1px;">Kurdish Master</h2>
                
                <div class="auth-switch">
                    <div class="switch-btn active" onclick="toggleAuth('login', this)">⁄ÜŸàŸàŸÜ€ï ⁄òŸàŸàÿ±</div>
                    <div class="switch-btn" onclick="toggleAuth('signup', this)">ÿ™€ÜŸÖÿßÿ±⁄©ÿ±ŸÜ</div>
                </div>

                <!-- Login Form -->
                <div id="form-login">
                    <input type="text" id="l-user" placeholder="ŸÜÿß⁄§€é ÿ®€ï⁄©ÿßÿ±Ÿá€éŸÜ€ïÿ±€å">
                    <input type="password" id="l-pass" placeholder="Ÿæÿßÿ≥ŸàŸàÿ±ÿØ">
                    <button class="btn btn-gold" onclick="login()">⁄ÜŸàŸàŸÜ€ï ⁄òŸàŸàÿ±</button>
                </div>

                <!-- Signup Form (FIXED) -->
                <div id="form-signup" style="display:none;">
                    <input type="text" id="s-user" placeholder="ŸÜÿß⁄§€é ÿ®€ï⁄©ÿßÿ±Ÿá€éŸÜ€ïÿ±€å (ŸÜŸà€å)">
                    <input type="password" id="s-pass" placeholder="Ÿæÿßÿ≥ŸàŸàÿ±ÿØ">
                    <input type="password" id="s-pass2" placeholder="ÿØŸàŸàÿ®ÿßÿ±€ï ÿ®ŸÜ⁄§€åÿ≥€ï">
                    <button class="btn btn-gold" onclick="signup()">ÿ™€ÜŸÖÿßÿ±⁄©ÿ±ŸÜ</button>
                </div>
            </div>
        </div>

        <!-- APP CONTENT -->
        <div id="app-content" style="display:none;">

            <!-- FOLDERS TAB -->
            <div id="tab-folders" class="container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2>ŸÅ€Ü⁄µÿØ€ïÿ±€éŸÜ ŸÖŸÜ</h2>
                    <button onclick="addFolder()" style="background:var(--gold); border:none; width:40px; height:40px; border-radius:50%; font-size:1.5em; font-weight:bold;">+</button>
                </div>
                <div id="folders-list"></div>
            </div>

            <!-- PROFILE TAB -->
            <div id="tab-profile" class="container" style="display:none;">
                <div class="card">
                    <div class="profile-header">
                        <img id="p-img-disp" src="" class="p-img">
                        <div class="p-stats">
                            <div><span class="stat-num" id="stat-sub">0</span>Subjects</div>
                            <div><span class="stat-num" id="stat-pts">0</span>Points</div>
                            <div><span class="stat-num" id="stat-fr">0</span>Friends</div>
                        </div>
                    </div>
                    <div class="bio-section">
                        <div id="p-name-disp" style="font-weight:bold; font-size:1.1em; color:white;">User</div>
                        <div id="p-bio-disp" style="color:#ccc;">Bio...</div>
                        <div id="p-id-disp" style="color:var(--gold); font-family:monospace; margin-top:5px; font-size:0.85em;">ID: ...</div>
                    </div>
                    <div class="social-links">
                        <a id="link-insta" href="#" target="_blank" class="s-link"><i class="fab fa-instagram"></i> Instagram</a>
                        <a id="link-snap" href="#" target="_blank" class="s-link"><i class="fab fa-snapchat"></i> Snapchat</a>
                    </div>
                    <button class="btn btn-gold" style="background:#222; border:1px solid #555; color:white; margin-top:0;" onclick="openEditProfile()">Edit Profile</button>
                    <button class="btn btn-red" style="margin-top:10px;" onclick="logout()">ÿØ€ïÿ±⁄©€ï⁄§ÿ™ŸÜ (Logout)</button>
                </div>
                <h3 style="color:var(--gold); margin:20px 0 10px 0;">ÿ±€åÿ≤ÿ®€ïŸÜÿØ€åÿß ŸÇŸàÿ™ÿßÿ®€åÿßŸÜ (Top Students)</h3>
                <div id="ranking-list"></div>
            </div>

            <!-- CHAT TAB -->
            <div id="tab-chat" class="container" style="display:none;">
                <h2 style="margin-bottom:15px;">ŸÜÿßŸÖ€ï Ÿà ⁄Øÿ±ŸàŸæ</h2>
                <div id="chat-conversations"></div>
            </div>

            <!-- SEARCH TAB -->
            <div id="tab-search" class="container" style="display:none;">
                <h2>ŸÑ€é⁄Ø€ï⁄ï€åÿßŸÜ (Search)</h2>
                <div class="card">
                    <input type="text" id="search-input" placeholder="ID ÿ®ŸÜ⁄§€åÿ≥€ï (std_...)">
                    <button class="btn btn-gold" onclick="searchAndAdd()">Add Friend</button>
                </div>
                <div id="friends-list" style="margin-top:20px;"></div>
            </div>

        </div>

        <!-- NAV BAR -->
        <div class="nav-bar" id="navbar" style="display:none;">
            <div class="nav-item active" onclick="switchTab('folders', this)"><i class="fas fa-folder"></i></div>
            <div class="nav-item" onclick="switchTab('search', this)"><i class="fas fa-search"></i></div>
            <div class="nav-item" onclick="switchTab('chat', this)"><i class="fas fa-comment"></i></div>
            <div class="nav-item" onclick="switchTab('profile', this)"><img id="nav-mini-pic" src="" class="nav-pic"></div>
        </div>
    </div>


    <!-- MODALS -->
    <!-- GRADE MODAL -->
    <div id="modal-grade" class="modal">
        <div class="modal-box">
            <h3 id="gm-title" style="color:var(--gold); text-align:center; margin-bottom:15px;">Quiz Info</h3>
            <input type="hidden" id="gm-fidx">
            <input type="hidden" id="gm-gidx">
            <input type="text" id="gm-name" placeholder="ŸÜÿß⁄§€é ⁄©Ÿà€åÿ≤€é">
            <div style="display:flex; gap:10px;">
                <input type="number" id="gm-max" placeholder="ŸÜŸÖÿ±€ï (Max)">
                <input type="number" id="gm-score" placeholder="ÿ™€ï ⁄Ü€ïŸÜÿØ ÿ¶€åŸÜÿß">
            </div>
            <button class="btn btn-gold" onclick="saveGrade()">Save</button>
            <button class="btn btn-red" id="gm-del-btn" style="display:none;" onclick="deleteGrade()">Delete Quiz</button>
            <button class="btn" style="background:transparent; color:#888; border:1px solid #444;" onclick="closeModal('modal-grade')">Cancel</button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="modal-profile" class="modal">
        <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
            <h3 style="color:var(--gold); text-align:center;">Edit Profile</h3>
            <label style="color:#aaa; font-size:0.8em; display:block; margin-top:10px;">Ÿà€éŸÜ€é Ÿæ⁄ï€ÜŸÅÿß€åŸÑ€å</label>
            <input type="file" id="ep-file" onchange="handleProfilePic(this)">
            <input type="text" id="ep-name" placeholder="ŸÜÿß⁄§">
            <textarea id="ep-bio" placeholder="Bio (⁄©Ÿàÿ±ÿ™€ï ÿ®ÿßÿ≥)" rows="3"></textarea>
            <input type="text" id="ep-insta" placeholder="Instagram Link">
            <input type="text" id="ep-snap" placeholder="Snapchat Link">
            <input type="text" id="ep-phone" placeholder="Phone Number">
            <button class="btn btn-gold" onclick="saveProfileChanges()">Update</button>
            <button class="btn" style="background:transparent; color:#888;" onclick="closeModal('modal-profile')">Close</button>
        </div>
    </div>

    <!-- CHAT ROOM -->
    <div id="chat-room">
        <div class="cr-header">
            <i class="fas fa-arrow-right" style="color:white; font-size:1.2em; cursor:pointer;" onclick="closeChat()"></i>
            <img id="cr-img" src="" class="c-avatar" style="width:35px; height:35px; margin-left:10px; margin-right:10px;">
            <span id="cr-name" style="font-weight:bold; color:var(--gold);">User</span>
        </div>
        
        <div id="cr-msgs" class="cr-body"></div>
        
        <div id="tools-menu">
            <div class="tool-item" onclick="sendTool('photo')"><i class="fas fa-image"></i> Ÿà€éŸÜ€ï / ⁄§€åÿØ€å€Ü</div>
            <div class="tool-item" onclick="sendTool('poll')"><i class="fas fa-poll"></i> ⁄ïÿßŸæÿ±ÿ≥€å (Poll)</div>
            <div class="tool-item" onclick="sendTool('tf')"><i class="fas fa-check-circle"></i> ⁄ïÿßÿ≥ÿ™ / ÿÆ€ïŸÑ€ïÿ™</div>
            <div class="tool-item" onclick="sendTool('mcq')"><i class="fas fa-list-ul"></i> Ÿá€ïŸÑÿ®⁄òÿßÿ±ÿ™ŸÜ (MCQ)</div>
            <div class="tool-item" onclick="sendTool('fib')"><i class="fas fa-pencil-alt"></i> Ÿæÿ±ÿ≥€åÿßÿ±ÿß ⁄§ÿßŸÑÿßŸá€å</div>
        </div>

        <div class="cr-footer">
            <i class="fas fa-plus-circle" style="color:var(--gold); font-size:1.5em; cursor:pointer;" onclick="toggleTools()"></i>
            <input type="text" id="msg-in" placeholder="ŸÜÿßŸÖ€ï..." style="margin:0; border-radius:20px; padding-right:15px;">
            <i class="fas fa-paper-plane" style="color:var(--gold); font-size:1.3em; cursor:pointer;" onclick="sendText()"></i>
        </div>
        <input type="file" id="chat-file-input" hidden onchange="processFileSend()">
    </div>

    <script>
        /* ---------------- DATA ---------------- */
        let users = JSON.parse(localStorage.getItem('km_users')) || [];
        let chats = JSON.parse(localStorage.getItem('km_chats')) || {}; 
        let currentUser = null;
        let activeChatID = null;

        /* ---------------- LOGIC ---------------- */
        function startApp() {
            const bg = document.getElementById('dynamic-bg');
            bg.classList.remove('bg-phase-1');
            bg.classList.add('bg-phase-2');
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';

            const sess = localStorage.getItem('km_session');
            if(sess) {
                currentUser = JSON.parse(sess);
                const fresh = users.find(u => u.id === currentUser.id);
                if(fresh) currentUser = fresh;
                showAppContent();
            } else {
                document.getElementById('auth-view').style.display = 'block';
            }
        }

        /* --- AUTH FIXED (Signup Repair) --- */
        function toggleAuth(type, btn) {
            document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('form-login').style.display = type==='login'?'block':'none';
            document.getElementById('form-signup').style.display = type==='signup'?'block':'none';
        }

        function signup() {
            // Updated Selection Logic
            const u = document.getElementById('s-user').value.trim();
            const p1 = document.getElementById('s-pass').value;
            const p2 = document.getElementById('s-pass2').value;

            if(!u || !p1 || !p2) return alert("Ÿá€å⁄§€å€ï Ÿá€ïŸÖ€å ÿ≤ÿßŸÜ€åÿßÿ±€åÿß Ÿæ⁄ï ÿ®⁄©€ï");
            if(p1 !== p2) return alert("Ÿæÿßÿ≥ŸàŸàÿ±ÿØ Ÿà€ï⁄© €å€ï⁄© ŸÜ€åŸÜŸÜ");
            
            // Check if user exists
            if(users.some(x => x.username === u)) return alert("ÿ¶€ï⁄§ ŸÜÿß⁄§€ï €å€é Ÿá€ï€åÿå ŸÜÿß⁄§€ï⁄©€é ÿØ€å Ÿá€ïŸÑÿ®⁄ò€éÿ±€ï");

            const newUser = {
                id: 'std_' + Date.now(),
                username: u, password: p1,
                photo: 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                bio: 'Student at Kurdish Master',
                insta: '', snap: '', phone: '',
                folders: [], friends: []
            };
            
            users.push(newUser);
            saveData();
            loginSuccess(newUser);
        }

        function login() {
            const u = document.getElementById('l-user').value.trim();
            const p = document.getElementById('l-pass').value;
            const found = users.find(x => x.username === u && x.password === p);
            
            if(found) loginSuccess(found);
            else alert("ŸÜÿß⁄§ €åÿßŸÜ Ÿæÿßÿ≥ŸàŸàÿ±ÿØ ÿÆ€ïŸÑ€ïÿ™€ï");
        }

        function loginSuccess(user) {
            currentUser = user;
            localStorage.setItem('km_session', JSON.stringify(user));
            document.getElementById('auth-view').style.display = 'none';
            showAppContent();
        }

        function logout() {
            localStorage.removeItem('km_session');
            location.reload();
        }

        function saveData() {
            if(currentUser) {
                const idx = users.findIndex(u => u.id === currentUser.id);
                if(idx !== -1) users[idx] = currentUser;
            }
            localStorage.setItem('km_users', JSON.stringify(users));
            localStorage.setItem('km_chats', JSON.stringify(chats));
        }

        function showAppContent() {
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('navbar').style.display = 'flex';
            refreshAll();
        }

        function refreshAll() {
            renderFolders();
            renderProfile();
            renderRanking();
            renderChatList();
            renderFriends();
        }

        /* --- TABS --- */
        function switchTab(tabName, navBtn) {
            document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
            document.getElementById('tab-' + tabName).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            navBtn.classList.add('active');
            if(tabName === 'profile') renderRanking();
            if(tabName === 'chat') renderChatList();
        }

        /* --- FOLDERS --- */
        function addFolder() {
            const name = prompt("ŸÜÿß⁄§€é ÿ®ÿßÿ®€ïÿ™€å (Subject Name):");
            if(name) { currentUser.folders.push({ name: name, grades: [] }); saveData(); renderFolders(); }
        }

        function renderFolders() {
            const list = document.getElementById('folders-list');
            list.innerHTML = '';
            currentUser.folders.forEach((folder, fIdx) => {
                let totalScore = 0, totalMax = 0;
                folder.grades.forEach(g => { totalScore += parseFloat(g.score)||0; totalMax += parseFloat(g.max)||0; });
                
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="folder-head">
                        <span class="folder-title">${folder.name}</span>
                        <span class="folder-score">${totalScore} / ${totalMax}</span>
                    </div>
                    <div style="font-size:0.8em; color:#888; margin-bottom:10px; cursor:pointer;" onclick="openGradeModal(${fIdx})"><i class="fas fa-plus"></i> ÿ≤€éÿØ€ï⁄©ÿ±ŸÜÿß ⁄©Ÿà€åÿ≤€é</div>
                    <div>${folder.grades.map((g, gIdx) => `
                        <div class="grade-item">
                            <span>${g.name}</span>
                            <span style="color:var(--gold); font-weight:bold; dir:ltr;">${g.score}/${g.max}</span>
                            <span class="grade-actions"><i class="fas fa-edit" onclick="openGradeModal(${fIdx}, ${gIdx})"></i></span>
                        </div>`).join('')}
                    </div>`;
                list.appendChild(div);
            });
        }

        function openGradeModal(fIdx, gIdx = -1) {
            document.getElementById('modal-grade').style.display = 'flex';
            document.getElementById('gm-fidx').value = fIdx;
            document.getElementById('gm-gidx').value = gIdx;
            const delBtn = document.getElementById('gm-del-btn');
            
            if(gIdx > -1) {
                const g = currentUser.folders[fIdx].grades[gIdx];
                document.getElementById('gm-name').value = g.name;
                document.getElementById('gm-max').value = g.max;
                document.getElementById('gm-score').value = g.score;
                document.getElementById('gm-title').innerText = "ÿØ€ïÿ≥ÿ™⁄©ÿßÿ±€å (Edit)";
                delBtn.style.display = 'inline-block';
            } else {
                document.getElementById('gm-name').value = '';
                document.getElementById('gm-max').value = '';
                document.getElementById('gm-score').value = '';
                document.getElementById('gm-title').innerText = "ÿ≤€éÿØ€ï⁄©ÿ±ŸÜ (Add)";
                delBtn.style.display = 'none';
            }
        }

        function saveGrade() {
            const fIdx = document.getElementById('gm-fidx').value;
            const gIdx = document.getElementById('gm-gidx').value;
            const name = document.getElementById('gm-name').value;
            const max = document.getElementById('gm-max').value;
            const score = document.getElementById('gm-score').value;
            if(!name || !max || !score) return alert("ÿ≤ÿßŸÜ€åÿßÿ±€åÿß Ÿæ⁄ï ÿ®⁄©€ï");
            
            if(gIdx > -1) currentUser.folders[fIdx].grades[gIdx] = { name, max, score };
            else currentUser.folders[fIdx].grades.push({ name, max, score });
            saveData(); renderFolders(); closeModal('modal-grade');
        }

        function deleteGrade() {
            if(confirm("ÿØ⁄µŸÜ€åÿß€å ÿØ€é ÿ±€ïÿ¥ ⁄©€ï€åÿü")) {
                const fIdx = document.getElementById('gm-fidx').value;
                const gIdx = document.getElementById('gm-gidx').value;
                currentUser.folders[fIdx].grades.splice(gIdx, 1);
                saveData(); renderFolders(); closeModal('modal-grade');
            }
        }

        /* --- PROFILE --- */
        function renderProfile() {
            const u = currentUser;
            document.getElementById('p-img-disp').src = u.photo;
            document.getElementById('nav-mini-pic').src = u.photo;
            document.getElementById('p-name-disp').innerText = u.username;
            document.getElementById('p-bio-disp').innerText = u.bio;
            document.getElementById('p-id-disp').innerText = "ID: " + u.id;
            document.getElementById('stat-sub').innerText = u.folders.length;
            document.getElementById('stat-fr').innerText = u.friends.length;
            document.getElementById('link-insta').href = u.insta || '#';
            document.getElementById('link-snap').href = u.snap || '#';
            let points = 0;
            u.folders.forEach(f => f.grades.forEach(g => points += parseFloat(g.score) || 0));
            document.getElementById('stat-pts').innerText = points;
        }

        function openEditProfile() {
            document.getElementById('modal-profile').style.display = 'flex';
            document.getElementById('ep-name').value = currentUser.username;
            document.getElementById('ep-bio').value = currentUser.bio;
            document.getElementById('ep-insta').value = currentUser.insta;
            document.getElementById('ep-snap').value = currentUser.snap;
            document.getElementById('ep-phone').value = currentUser.phone;
        }

        function handleProfilePic(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => currentUser.photo = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfileChanges() {
            currentUser.username = document.getElementById('ep-name').value;
            currentUser.bio = document.getElementById('ep-bio').value;
            currentUser.insta = document.getElementById('ep-insta').value;
            currentUser.snap = document.getElementById('ep-snap').value;
            currentUser.phone = document.getElementById('ep-phone').value;
            saveData(); renderProfile(); closeModal('modal-profile');
        }

        function renderRanking() {
            // FILTER: Only show users who are in my friends list OR myself
            let myCircle = users.filter(u => currentUser.friends.includes(u.id) || u.id === currentUser.id);

            let rankedUsers = myCircle.map(u => {
                let total = 0;
                if(u.folders) u.folders.forEach(f => f.grades.forEach(g => total += parseFloat(g.score)||0));
                return { name: u.username, score: total, id: u.id };
            }).sort((a, b) => b.score - a.score).slice(0, 5);

            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            rankedUsers.forEach((u, i) => {
                list.innerHTML += `
                    <div class="rank-card">
                        <span class="rank-num">${i+1}</span>
                        <div style="flex:1;">
                            <div class="rank-user">${u.name}</div>
                            <div style="font-size:0.8em; color:#aaa;">${u.score} Points</div>
                        </div>
                        ${u.id === currentUser.id ? '<i class="fas fa-star" style="color:var(--gold)"></i>' : ''}
                    </div>`;
            });
        }

        /* --- CHAT & FRIENDS --- */
        function searchAndAdd() {
            const input = document.getElementById('search-input').value.trim();
            if(input === currentUser.id) return alert("ŸÜ€ïÿ¥€é€å ÿÆ€Ü ÿ≤€éÿØ€ï ⁄©€ï€å");
            const target = users.find(u => u.id === input);
            if(target) {
                if(!currentUser.friends.includes(target.id)) {
                    currentUser.friends.push(target.id);
                    saveData(); renderFriends(); renderChatList();
                    alert(target.username + " Ÿáÿßÿ™€ï ÿ≤€éÿØ€ï⁄©ÿ±ŸÜ");
                } else alert("ÿ¶€ï⁄§ Ÿá€ïŸÅÿßŸÑ€ï €å€é Ÿá€ï€å");
            } else alert("ID ÿÆ€ïŸÑ€ïÿ™€ï");
        }

        function renderFriends() {
            const div = document.getElementById('friends-list');
            div.innerHTML = '';
            currentUser.friends.forEach(fid => {
                const f = users.find(u => u.id === fid);
                if(f) div.innerHTML += `<div class="card" style="padding:10px; display:flex; align-items:center;">
                        <img src="${f.photo}" style="width:40px; height:40px; border-radius:50%; margin-left:10px;">
                        <span>${f.username}</span></div>`;
            });
        }

        function renderChatList() {
            const div = document.getElementById('chat-conversations');
            div.innerHTML = '';
            currentUser.friends.forEach(fid => {
                const f = users.find(u => u.id === fid);
                if(f) div.innerHTML += `<div class="chat-row" onclick="openChat('${f.id}', '${f.username}', '${f.photo}')">
                            <img src="${f.photo}" class="c-avatar">
                            <div style="margin-right:15px; font-weight:bold;">${f.username}</div>
                        </div>`;
            });
        }

        function openChat(pid, pname, pimg) {
            activeChatID = [currentUser.id, pid].sort().join('_');
            document.getElementById('chat-room').style.display = 'flex';
            document.getElementById('cr-name').innerText = pname;
            document.getElementById('cr-img').src = pimg;
            renderMessages();
        }
        function closeChat() { document.getElementById('chat-room').style.display = 'none'; activeChatID = null; }

        function renderMessages() {
            if(!activeChatID) return;
            const msgs = chats[activeChatID] || [];
            const container = document.getElementById('cr-msgs');
            container.innerHTML = '';
            msgs.forEach(m => {
                let content = '';
                // Handle different message types specifically
                if(m.type === 'text') {
                    content = m.text;
                } 
                else if(m.type === 'photo') {
                    content = `<img src="${m.text}" style="max-width:100%; border-radius:10px;">`;
                }
                else if(m.type === 'poll') {
                    content = `
                        <div class="edu-widget">
                            <strong>üìä ${m.data.q}</strong>
                            <div class="poll-bar"><div class="poll-fill" style="width:50%; background:var(--gold);"></div></div>
                        </div>`;
                }
                else if(m.type === 'mcq') {
                    content = `
                        <div class="edu-widget">
                            <strong>‚ùì ${m.data.q}</strong>
                            ${m.data.opts.map(o => `<span class="quiz-opt" onclick="checkMCQ(this, '${o}', '${m.data.ans}')">${o}</span>`).join('')}
                        </div>`;
                }
                else if(m.type === 'tf') {
                    content = `
                        <div class="edu-widget">
                            <strong>‚úÖ/‚ùå ${m.data.q}</strong>
                            <span class="quiz-opt" onclick="checkMCQ(this, 'True', '${m.data.ans}')">True</span>
                            <span class="quiz-opt" onclick="checkMCQ(this, 'False', '${m.data.ans}')">False</span>
                        </div>`;
                }
                else if(m.type === 'fib') {
                    content = `
                        <div class="edu-widget">
                            <strong>üñä ${m.data.q}</strong>
                            <input type="text" placeholder="ÿ®€ïÿ±ÿ≥⁄§..." onblur="checkFIB(this, '${m.data.ans}')" style="background:#000; margin-top:5px;">
                        </div>`;
                }

                container.innerHTML += `
                    <div style="display:flex;">
                        <div class="msg ${m.sender === currentUser.id ? 'msg-me' : 'msg-other'}">
                            ${content}
                        </div>
                    </div>`;
            });
            container.scrollTop = container.scrollHeight;
        }

        function checkMCQ(el, selected, correct) {
            if(selected === correct) el.classList.add('quiz-correct');
            else el.classList.add('quiz-wrong');
        }
        function checkFIB(input, correct) {
            if(input.value.trim().toLowerCase() === correct.toLowerCase()) { input.style.borderColor = "#28a745"; input.style.color = "#28a745"; }
            else { input.style.borderColor = "#dc3545"; input.style.color = "#dc3545"; }
        }

        function sendText() {
            const txt = document.getElementById('msg-in').value;
            if(txt && activeChatID) { pushMsg({ sender: currentUser.id, type: 'text', text: txt }); document.getElementById('msg-in').value = ''; }
        }

        function toggleTools() { const m = document.getElementById('tools-menu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
        
        function sendTool(type) {
            toggleTools();
            if(type === 'photo') document.getElementById('chat-file-input').click();
            else if(type === 'poll') { const q = prompt("Ÿæÿ±ÿ≥€åÿßÿ±:"); if(q) pushMsg({ sender: currentUser.id, type: 'poll', data: {q} }); }
            else if(type === 'mcq') { const q = prompt("Ÿæÿ±ÿ≥€åÿßÿ±:"); const o1 = prompt("Ÿá€ïŸÑÿ®⁄òÿßÿ±ÿØ€ï 1:"); const o2 = prompt("Ÿá€ïŸÑÿ®⁄òÿßÿ±ÿØ€ï 2:"); const ans = prompt("⁄©€å⁄ò€ï €åÿß ÿ±ÿßÿ≥ÿ™€ïÿü"); if(q&&o1) pushMsg({ sender: currentUser.id, type: 'mcq', data: {q, opts:[o1,o2], ans} }); }
            else if(type === 'tf') { const q = prompt("Ÿæÿ±ÿ≥€åÿßÿ±:"); const ans = prompt("ÿ®€ïÿ±ÿ≥⁄§ (True/False):"); if(q) pushMsg({ sender: currentUser.id, type: 'tf', data: {q, ans} }); }
            else if(type === 'fib') { const q = prompt("Ÿæÿ±ÿ≥€åÿßÿ±:"); const ans = prompt("ÿ®€ïÿ±ÿ≥⁄§:"); if(q) pushMsg({ sender: currentUser.id, type: 'fib', data: {q, ans} }); }
        }

        function processFileSend() {
            const file = document.getElementById('chat-file-input').files[0];
            const reader = new FileReader();
            reader.onload = e => pushMsg({ sender: currentUser.id, type: 'photo', text: e.target.result });
            if(file) reader.readAsDataURL(file);
        }

        function pushMsg(msgObj) {
            if(!chats[activeChatID]) chats[activeChatID] = [];
            chats[activeChatID].push(msgObj);
            saveData(); renderMessages();
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
